(function(){(function(a,b,c){a.Offline={VERSION:"0.4.0.alfa",localSync:function(a,c,d,e){var f;f=function(){switch(a){case"read":if(b.isUndefined(c.id)){return e.findAll(d)}else{return e.find(c,d)}break;case"create":return e.create(c,d);case"update":return e.update(c,d);case"delete":return e.destroy(c,d)}}();if(f){return d.success(f)}else{return d.error("Record not found")}},sync:function(a,b,d){var e,f;e=b.storage||((f=b.collection)!=null?f.storage:void 0);if(e&&(e!=null?e.support:void 0)){return Offline.localSync(a,b,d,e)}else{return c.ajaxSync(a,b,d)}},onLine:function(){return navigator.onLine!==false}};c.ajaxSync=c.sync;c.sync=Offline.sync;Offline.Storage=function(){function a(a,b,c){this.name=a;this.collection=b;if(c==null){c={}}this.support=this.isLocalStorageSupport();this.allIds=new Offline.Index(this.name,this);this.destroyIds=new Offline.Index(""+this.name+"-destroy",this);this.sync=new Offline.Sync(this.collection,this);this.keys=c.keys||{};this.autoPush=c.autoPush||false}a.prototype.isLocalStorageSupport=function(){try{localStorage.setItem("isLocalStorageSupport","1");localStorage.removeItem("isLocalStorageSupport");return true}catch(a){return false}};a.prototype.setItem=function(a,b){try{return localStorage.setItem(a,b)}catch(c){if(c.name==="QUOTA_EXCEEDED_ERR"){return this.collection.trigger("quota_exceed")}else{return this.support=false}}};a.prototype.removeItem=function(a){return localStorage.removeItem(a)};a.prototype.getItem=function(a){return localStorage.getItem(a)};a.prototype.create=function(a,b){if(b==null){b={}}b.regenerateId=true;return this.save(a,b)};a.prototype.update=function(a,b){if(b==null){b={}}return this.save(a,b)};a.prototype.destroy=function(a,b){var c;if(b==null){b={}}if(!(b.local||(c=a.get("sid"))==="new")){this.destroyIds.add(c)}return this.remove(a,b)};a.prototype.find=function(a,b){if(b==null){b={}}return JSON.parse(this.getItem(""+this.name+"-"+a.id))};a.prototype.findAll=function(a){var b,c,d,e,f;if(a==null){a={}}if(!a.local){if(this.isEmpty()){this.sync.full()}else{this.sync.incremental()}}e=this.allIds.values;f=[];for(c=0,d=e.length;c<d;c++){b=e[c];f.push(JSON.parse(this.getItem(""+this.name+"-"+b)))}return f};a.prototype.s4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};a.prototype.guid=function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()};a.prototype.save=function(a,b){var c,d;if(b==null){b={}}if(b.regenerateId){a.set({sid:((c=a.attributes)!=null?c.sid:void 0)||((d=a.attributes)!=null?d.id:void 0)||"new",id:this.guid()})}if(!b.local){a.set({updated_at:(new Date).toJSON(),dirty:true})}this.replaceKeyFields(a,"local");this.setItem(""+this.name+"-"+a.id,JSON.stringify(a));this.allIds.add(a.id);if(this.autoPush&&!b.local){this.sync.pushItem(a)}return a};a.prototype.remove=function(a,b){var c;if(b==null){b={}}this.removeItem(""+this.name+"-"+a.id);this.allIds.remove(a.id);c=a.get("sid");if(this.autoPush&&c!=="new"&&!b.local){this.sync.flushItem(c)}return a};a.prototype.isEmpty=function(){return this.getItem(this.name)===null};a.prototype.clear=function(){var a,c,d,e,f,g,h,i,j,k,l=this;d=Object.keys(localStorage);a=b.filter(d,function(a){return(new RegExp(l.name)).test(a)});for(f=0,h=a.length;f<h;f++){c=a[f];this.removeItem(c)}j=[this.allIds,this.destroyIds];k=[];for(g=0,i=j.length;g<i;g++){e=j[g];k.push(e.reset())}return k};a.prototype.replaceKeyFields=function(a,c){var d,e,f,g,h,i,j,k;if(Offline.onLine()){if(a.attributes){a=a.attributes}i=this.keys;for(e in i){d=i[e];g=a[e];if(!/^\w{8}-\w{4}-\w{4}/.test(g)||c!=="local"){f=c==="local"?(h=new Offline.Collection(d),(j=h.get(g))!=null?j.id:void 0):(k=d.get(g))!=null?k.get("sid"):void 0;if(!b.isUndefined(f)){a[e]=f}}}}return a};return a}();Offline.Sync=function(){function a(a,b){this.collection=new Offline.Collection(a);this.storage=b}a.prototype.ajax=function(a,b,d){if(Offline.onLine()){this.prepareOptions(d);return c.ajaxSync(a,b,d)}else{return this.storage.setItem("offline","true")}};a.prototype.full=function(a){var b=this;if(a==null){a={}}return this.ajax("read",this.collection.items,{success:function(c,d,e){var f,g,h;b.storage.clear();b.collection.items.reset([],{silent:true});for(g=0,h=c.length;g<h;g++){f=c[g];b.collection.items.create(f,{silent:true,local:true,regenerateId:true})}if(!a.silent){b.collection.items.trigger("reset")}if(a.success){return a.success(c)}}})};a.prototype.incremental=function(){var a=this;return this.pull({success:function(){return a.push()}})};a.prototype.prepareOptions=function(a){var b,c=this;if(this.storage.getItem("offline")){this.storage.removeItem("offline");b=a.success;return a.success=function(a,d,e){b(a,d,e);return c.incremental()}}};a.prototype.pull=function(a){var b=this;if(a==null){a={}}return this.ajax("read",this.collection.items,{success:function(c,d,e){var f,g,h;b.collection.destroyDiff(c);for(g=0,h=c.length;g<h;g++){f=c[g];b.pullItem(f)}if(a.success){return a.success()}}})};a.prototype.pullItem=function(a){var b;b=this.collection.get(a.id);if(b){return this.updateItem(a,b)}else{return this.createItem(a)}};a.prototype.createItem=function(a){if(!b.include(this.storage.destroyIds.values,a.id.toString())){a.sid=a.id;delete a.id;return this.collection.items.create(a,{local:true})}};a.prototype.updateItem=function(a,b){if(new Date(b.get("updated_at"))<new Date(a.updated_at)){delete a.id;return b.save(a,{local:true})}};a.prototype.push=function(){var a,b,c,d,e,f,g,h,i;g=this.collection.dirty();for(c=0,e=g.length;c<e;c++){a=g[c];this.pushItem(a)}h=this.storage.destroyIds.values;i=[];for(d=0,f=h.length;d<f;d++){b=h[d];i.push(this.flushItem(b))}return i};a.prototype.pushItem=function(a){var b,c,d,e=this;this.storage.replaceKeyFields(a,"server");b=a.id;delete a.attributes.id;d=a.get("sid")==="new"?["create",null]:["update",a.attributes.sid],c=d[0],a.id=d[1];this.ajax(c,a,{success:function(b,d,e){if(c==="create"){a.set({sid:b.id})}return a.save({dirty:false},{local:true})}});a.attributes.id=b;return a.id=b};a.prototype.flushItem=function(a){var b,c=this;b=this.collection.fakeModel(a);return this.ajax("delete",b,{success:function(b,d,e){return c.storage.destroyIds.remove(a)}})};return a}();Offline.Index=function(){function a(a,b){var c;this.name=a;this.storage=b;c=this.storage.getItem(this.name);this.values=c&&c.split(",")||[]}a.prototype.add=function(a){if(!b.include(this.values,a.toString())){this.values.push(a.toString())}return this.save()};a.prototype.remove=function(a){this.values=b.without(this.values,a.toString());return this.save()};a.prototype.save=function(){return this.storage.setItem(this.name,this.values.join(","))};a.prototype.reset=function(){this.values=[];return this.storage.removeItem(this.name)};return a}();return Offline.Collection=function(){function a(a){this.items=a}a.prototype.dirty=function(){return this.items.where({dirty:true})};a.prototype.get=function(a){return this.items.find(function(b){return b.get("sid")===a})};a.prototype.destroyDiff=function(a){var c,d,e,f,g,h;c=b.difference(b.without(this.items.pluck("sid"),"new"),b.pluck(a,"id"));h=[];for(e=0,f=c.length;e<f;e++){d=c[e];h.push((g=this.get(d))!=null?g.destroy({local:true}):void 0)}return h};a.prototype.fakeModel=function(a){var b;b=new c.Model({id:a});b.urlRoot=this.items.url;return b};return a}()})(window,_,Backbone)}).call(this)
